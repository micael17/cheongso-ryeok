---
import { getCollection } from 'astro:content';

// Í∞Å Ïª¨Î†âÏÖòÏóêÏÑú ÏµúÏã† Í∏Ä Í∞ÄÏ†∏Ïò§Í∏∞
const reviews = await getCollection('review', ({ data }) => !data.draft);
const compares = await getCollection('compare', ({ data }) => !data.draft);
const guides = await getCollection('guide', ({ data }) => !data.draft);

// Î™®Îì† Í∏ÄÏùÑ Ìï©Ï≥êÏÑú ÏµúÏã†Ïàú Ï†ïÎ†¨
const allPosts = [
  ...reviews.map(post => ({ ...post, collection: 'review' as const, label: 'Î¶¨Î∑∞' })),
  ...compares.map(post => ({ ...post, collection: 'compare' as const, label: 'ÎπÑÍµê' })),
  ...guides.map(post => ({ ...post, collection: 'guide' as const, label: 'Í∞ÄÏù¥Îìú' })),
].sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// ÏµúÍ∑º 5Í∞úÎßå
const recentPosts = allPosts.slice(0, 5);

// Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Í∏Ä Í∞úÏàò
const categories = [
  { name: 'Î¶¨Î∑∞', slug: 'review', count: reviews.length, icon: 'üìù' },
  { name: 'ÎπÑÍµê', slug: 'compare', count: compares.length, icon: '‚öñÔ∏è' },
  { name: 'Í∞ÄÏù¥Îìú', slug: 'guide', count: guides.length, icon: 'üìö' },
];

// Ï≤≠ÏÜåÍ∏∞ Ïú†ÌòïÎ≥Ñ Î∂ÑÎ•ò
const types = [
  { name: 'Î¨¥ÏÑ†Ï≤≠ÏÜåÍ∏∞', icon: 'üîã' },
  { name: 'Î°úÎ¥áÏ≤≠ÏÜåÍ∏∞', icon: 'ü§ñ' },
  { name: 'Î¨ºÍ±∏Î†àÏ≤≠ÏÜåÍ∏∞', icon: 'üíß' },
];

const typeCount = (typeName: string) => {
  return [...reviews, ...compares].filter(post => post.data.type === typeName).length;
};
---

<aside class="sidebar">
  <!-- Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑπÏÖò -->
  <section class="sidebar-section">
    <h3 class="sidebar-title">Ïπ¥ÌÖåÍ≥†Î¶¨</h3>
    <ul class="category-list">
      {categories.map(cat => (
        <li>
          <a href={`/${cat.slug}`} class="category-link">
            <span class="category-icon">{cat.icon}</span>
            <span class="category-name">{cat.name}</span>
            <span class="category-count">{cat.count}</span>
          </a>
        </li>
      ))}
    </ul>
  </section>

  <!-- Ï≤≠ÏÜåÍ∏∞ Ïú†Ìòï ÏÑπÏÖò -->
  <section class="sidebar-section">
    <h3 class="sidebar-title">Ï≤≠ÏÜåÍ∏∞ Ïú†Ìòï</h3>
    <ul class="type-list">
      {types.map(type => (
        <li>
          <span class="type-item">
            <span class="type-icon">{type.icon}</span>
            <span class="type-name">{type.name}</span>
            <span class="type-count">{typeCount(type.name)}</span>
          </span>
        </li>
      ))}
    </ul>
  </section>

  <!-- ÏµúÏã† Í∏Ä ÏÑπÏÖò -->
  <section class="sidebar-section">
    <h3 class="sidebar-title">ÏµúÏã† Í∏Ä</h3>
    <ul class="recent-posts">
      {recentPosts.map(post => (
        <li>
          <a href={`/${post.collection}/${post.id}`} class="recent-post-link">
            <span class="post-label" data-type={post.collection}>{post.label}</span>
            <span class="post-title">{post.data.title}</span>
          </a>
        </li>
      ))}
    </ul>
  </section>

  <!-- Ïø†Ìå° Î∞∞ÎÑà -->
  <section class="sidebar-section sidebar-ad">
    <iframe
      src="https://ads-partners.coupang.com/widgets.html?id=387698&template=carousel&trackingCode=AF1409487&subId=&width=300&height=300&tsource="
      width="100%"
      height="300"
      frameborder="0"
      scrolling="no"
      referrerpolicy="unsafe-url"
      browsingtopics>
    </iframe>
  </section>
</aside>

<style>
  .sidebar {
    width: 280px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .sidebar-section {
    background: rgb(var(--gray-50));
    border: 1px solid rgb(var(--gray-200));
    border-radius: 12px;
    padding: 1.25rem;
  }

  .sidebar-title {
    font-size: 0.9375rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid rgb(var(--accent));
    color: rgb(var(--gray-dark));
  }

  .category-list,
  .type-list,
  .recent-posts {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .category-list li,
  .type-list li {
    margin-bottom: 0.5rem;
  }

  .category-link,
  .type-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    text-decoration: none;
    color: rgb(var(--gray-dark));
    transition: background 0.2s;
  }

  .category-link:hover {
    background: rgb(var(--gray-100));
  }

  .type-item {
    cursor: default;
  }

  .category-icon,
  .type-icon {
    font-size: 1rem;
  }

  .category-name,
  .type-name {
    flex: 1;
    font-size: 0.875rem;
  }

  .category-count,
  .type-count {
    font-size: 0.75rem;
    background: rgb(var(--accent));
    color: white;
    padding: 0.125rem 0.5rem;
    border-radius: 999px;
    font-weight: 500;
  }

  .recent-posts li {
    margin-bottom: 0.75rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid rgb(var(--gray-200));
  }

  .recent-posts li:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
    border-bottom: none;
  }

  .recent-post-link {
    display: block;
    text-decoration: none;
    color: rgb(var(--gray-dark));
    transition: color 0.2s;
  }

  .recent-post-link:hover {
    color: rgb(var(--accent));
  }

  .post-label {
    display: inline-block;
    font-size: 0.625rem;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    margin-bottom: 0.25rem;
    font-weight: 500;
    text-transform: uppercase;
  }

  .post-label[data-type="review"] {
    background: #e0f2fe;
    color: #0369a1;
  }

  .post-label[data-type="compare"] {
    background: #fef3c7;
    color: #b45309;
  }

  .post-label[data-type="guide"] {
    background: #dcfce7;
    color: #15803d;
  }

  .post-title {
    display: block;
    font-size: 0.8125rem;
    line-height: 1.4;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .sidebar-ad {
    padding: 0.75rem;
  }

  .sidebar-ad iframe {
    border-radius: 8px;
  }

  /* Î™®Î∞îÏùºÏóêÏÑúÎäî ÏÇ¨Ïù¥ÎìúÎ∞î Ïà®ÍπÄ */
  @media (max-width: 1024px) {
    .sidebar {
      display: none;
    }
  }
</style>
